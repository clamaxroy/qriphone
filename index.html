<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONTROLLO QR-CODE</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <!-- Importazione della libreria -->
    <script src="https://unpkg.com/qr-scanner@1.4.1/qr-scanner.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #105b90;
            color: #fedb02;
            padding: 20px;
        }
        #toggleCameraButton {
            margin: 10px auto;
            padding: 0;
            font-size: 14px;
            cursor: pointer;
            background-color: green;
            color: white;
            border: none;
            border-radius: 25px;
            width: 130px;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-weight: bold;
        }
        #menu {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        .menu-button {
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.3s;
        }
        .menu-button:hover {
            opacity: 0.8;
        }
        #resetButton { background-color: red; color: white; }
        #exportExcelButton { background-color: blue; color: white; }
        #showAllButton { background-color: orange; color: white; }
        #searchContainer {
            margin-top: 10px;
        }
        #searchInput {
            padding: 8px;
            width: 200px;
            border-radius: 15px;
            border: 1px solid #ccc;
            text-align: center;
        }
        #cameraFeed {
            display: none;
            width: 100%;
            max-width: 400px;
            margin-top: 10px;
        }
        #guestList {
            background-color: white;
            color: black;
            padding: 10px;
            margin-top: 20px;
            max-width: 400px;
            border-radius: 5px;
            border: 1px solid #ccc;
            display: block;
            text-align: left;
        }
        .guest {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }
        .delete-button {
            background-color: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            text-align: center;
            line-height: 22px;
        }
    </style>
</head>
<body>
    <h1>IKEA - Fuori Salone</h1>
    <h2>Scansiona Tessere IKEA Family</h2>

    <button id="toggleCameraButton">Scan QR-Code</button>

    <!-- Menu con pulsanti -->
    <div id="menu">
        <button id="resetButton" class="menu-button">Reset</button>
        <button id="exportExcelButton" class="menu-button">Report Excel</button>
        <button id="showAllButton" class="menu-button">Mostra Tutti</button>
    </div>

    <!-- Ricerca -->
    <div id="searchContainer">
        <input type="text" id="searchInput" placeholder="Cerca Tessera">
    </div>

    <video id="cameraFeed" autoplay playsinline></video>
    <div id="guestList"></div>

    <script>
        const toggleCameraButton = document.getElementById('toggleCameraButton');
        const cameraFeed = document.getElementById('cameraFeed');
        let videoStream = null;
        let qrScanner = null;
        let guestList = JSON.parse(localStorage.getItem('guestList')) || [];

        toggleCameraButton.addEventListener('click', function () {
            if (videoStream) {
                stopCamera();
            } else {
                startCamera();
            }
        });

        async function startCamera() {
            try {
                const constraints = {
                    video: { facingMode: "environment" }
                };

                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraFeed.srcObject = videoStream;
                cameraFeed.style.display = "block";
                toggleCameraButton.textContent = "Disattiva";

                qrScanner = new QrScanner(
                    cameraFeed,
                    result => handleScan(result),
                    { highlightScanRegion: true, highlightCodeOutline: true }
                );
                qrScanner.start();
            } catch (error) {
                alert("Errore nell'attivazione della fotocamera: " + error.message);
            }
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            if (qrScanner) {
                qrScanner.stop();
                qrScanner.destroy();
                qrScanner = null;
            }
            cameraFeed.style.display = "none";
            toggleCameraButton.textContent = "Scan QR-Code";
        }

        function handleScan(result) {
            let scannedText = result.data ? String(result.data).trim() : String(result).trim();
            if (!scannedText) return;

            stopCamera();
            addScannedCode(scannedText);
        }

        function addScannedCode(scannedText) {
            if (!scannedText) return;

            const existingGuest = guestList.find(guest => guest.text === scannedText);
            if (existingGuest) {
                alert("⚠️ Tessera già registrata");
                return;
            }

            const now = new Date();
            const guestItem = {
                text: scannedText,
                time: now.toLocaleTimeString()
            };

            guestList.unshift(guestItem);
            localStorage.setItem('guestList', JSON.stringify(guestList));
            updateGuestList();
        }

        function updateGuestList(filteredData = guestList) {
            guestListContainer.innerHTML = '';
            filteredData.forEach((guest, index) => {
                const guestItemElement = document.createElement('div');
                guestItemElement.classList.add('guest');
                guestItemElement.innerHTML = `
                    <div>
                        <span><strong>${guest.time}</strong> - ${guest.text}</span>
                    </div>
                    <button class="delete-button" onclick="removeGuest(${index})">X</button>
                `;
                guestListContainer.appendChild(guestItemElement);
            });
        }

        function removeGuest(index) {
            if (confirm("Sei sicuro di eliminare?")) {
                guestList.splice(index, 1);
                localStorage.setItem('guestList', JSON.stringify(guestList));
                updateGuestList();
            }
        }

        document.getElementById('resetButton').addEventListener('click', function () {
            if (confirm("Sei sicuro di cancellare tutti i dati?")) {
                guestList = [];
                localStorage.setItem('guestList', JSON.stringify(guestList));
                updateGuestList();
            }
        });

        document.getElementById('exportExcelButton').addEventListener('click', function () {
            if (guestList.length === 0) {
                alert("Nessun dato da esportare.");
                return;
            }

            let ws = XLSX.utils.json_to_sheet(guestList);
            let wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Guests");
            XLSX.writeFile(wb, "Report_Ospiti.xlsx");
        });

        document.getElementById('searchInput').addEventListener('input', function () {
            let query = this.value.toLowerCase();
            let filteredList = guestList.filter(guest => guest.text.toLowerCase().includes(query));
            updateGuestList(filteredList);
        });

        updateGuestList();
    </script>
</body>
</html>
